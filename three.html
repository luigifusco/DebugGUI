<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; background: grey; }
		</style>
	</head>
	<body>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
		<script>
            fetch("data.json").then(
                response => response.json()
            ).then( data => {

                var data = {"vtx":[[120,79,4027518735,0.12793,0.000488281],[213,79,4027518735,0.12793,0.000488281],[213,108,4027518735,0.12793,0.000488281],[120,108,4027518735,0.12793,0.000488281],[120,60,4286204457,0.12793,0.000488281],[213,60,4286204457,0.12793,0.000488281],[213,79,4286204457,0.12793,0.000488281],[120,79,4286204457,0.12793,0.000488281],[199.354,106.854,872060482,0.12793,0.000488281],[198.646,107.146,16422466,0.12793,0.000488281],[211.854,94.3536,872060482,0.12793,0.000488281],[212.146,93.6464,16422466,0.12793,0.000488281],[211.5,106.5,872060482,0.12793,0.000488281],[212.5,107.5,16422466,0.12793,0.000488281],[119,59,2155900526,0.0605469,0.00146484],[122,62,2155900526,0.0664062,0.00146484],[214,59,2155900526,0.0605469,0.00146484],[211,62,2155900526,0.0664062,0.00146484],[214,109,2155900526,0.0605469,0.00146484],[211,106,2155900526,0.0664062,0.00146484],[119,109,2155900526,0.0605469,0.00146484],[122,106,2155900526,0.0664062,0.00146484],[131.5,72.9,4294967295,0.12793,0.000488281],[131.5,73.9,16777215,0.12793,0.000488281],[127.43,65.85,4294967295,0.12793,0.000488281],[126.564,65.35,16777215,0.12793,0.000488281],[135.57,65.85,4294967295,0.12793,0.000488281],[136.436,65.35,16777215,0.12793,0.000488281],[142,66,4294967295,0.958984,0.0214844],[149,66,4294967295,0.972656,0.0214844],[149,74,4294967295,0.972656,0.0292969],[142,74,4294967295,0.958984,0.0292969],[150,68,4294967295,0.638672,0.03125],[155,68,4294967295,0.648438,0.03125],[155,74,4294967295,0.648438,0.0371094],[150,74,4294967295,0.638672,0.0371094],[157,68,4294967295,0.650391,0.03125],[162,68,4294967295,0.660156,0.03125],[162,74,4294967295,0.660156,0.0371094],[157,74,4294967295,0.650391,0.0371094],[165,65,4294967295,0.847656,0.0214844],[167,65,4294967295,0.851562,0.0214844],[167,74,4294967295,0.851562,0.0302734],[165,74,4294967295,0.847656,0.0302734],[171,65,4294967295,0.839844,0.0117188],[176,65,4294967295,0.849609,0.0117188],[176,74,4294967295,0.849609,0.0205078],[171,74,4294967295,0.839844,0.0205078],[129,90,4294967295,0.224609,0.0273438],[135,90,4294967295,0.236328,0.0273438],[135,98,4294967295,0.236328,0.0351562],[129,98,4294967295,0.224609,0.0351562],[136,92,4294967295,0.591797,0.03125],[141,92,4294967295,0.601562,0.03125],[141,98,4294967295,0.601562,0.0371094],[136,98,4294967295,0.591797,0.0371094],[142,92,4294967295,0.945312,0.0302734],[149,92,4294967295,0.958984,0.0302734],[149,98,4294967295,0.958984,0.0361328],[142,98,4294967295,0.945312,0.0361328],[150,92,4294967295,0.898438,0.0117188],[155,92,4294967295,0.908203,0.0117188],[155,101,4294967295,0.908203,0.0205078],[150,101,4294967295,0.898438,0.0205078],[158,89,4294967295,0.847656,0.0214844],[160,89,4294967295,0.851562,0.0214844],[160,98,4294967295,0.851562,0.0302734],[158,98,4294967295,0.847656,0.0302734],[164,92,4294967295,0.615234,0.03125],[169,92,4294967295,0.625,0.03125],[169,98,4294967295,0.625,0.0371094],[164,98,4294967295,0.615234,0.0371094],[179,90,4294967295,0.876953,0.0302734],[183,90,4294967295,0.884766,0.0302734],[183,98,4294967295,0.884766,0.0380859],[179,98,4294967295,0.876953,0.0380859],[185,92,4294967295,0.615234,0.03125],[190,92,4294967295,0.625,0.03125],[190,98,4294967295,0.625,0.0371094],[185,98,4294967295,0.615234,0.0371094],[192,92,4294967295,0.697266,0.03125],[197,92,4294967295,0.707031,0.03125],[197,98,4294967295,0.707031,0.0371094],[192,98,4294967295,0.697266,0.0371094],[200,90,4294967295,0.876953,0.0302734],[204,90,4294967295,0.884766,0.0302734],[204,98,4294967295,0.884766,0.0380859],[200,98,4294967295,0.876953,0.0380859],],"idx":[0,1,2,0,2,3,4,5,6,4,6,7,8,10,12,8,12,13,13,9,8,10,8,9,9,11,10,12,10,11,11,13,12,16,14,15,17,15,16,18,16,17,19,17,18,20,18,19,21,19,20,14,20,21,15,21,14,22,24,26,22,26,27,27,23,22,24,22,23,23,25,24,26,24,25,25,27,26,28,29,30,28,30,31,32,33,34,32,34,35,36,37,38,36,38,39,40,41,42,40,42,43,44,45,46,44,46,47,48,49,50,48,50,51,52,53,54,52,54,55,56,57,58,56,58,59,60,61,62,60,62,63,64,65,66,64,66,67,68,69,70,68,70,71,72,73,74,72,74,75,76,77,78,76,78,79,80,81,82,80,82,83,84,85,86,84,86,87,],"cmd":[108,60,]}
                var guniforms = {
                    tTex: { type: 't', value: null },
                    uClip: { type: 'v4', value: new THREE.Vector4() },
                };

                var ImVS = [
                    "attribute float alpha;",

                    "varying vec3 vColor;",
                    "varying vec2 vUv;",
                    "varying float vAlpha;",

                    "void main() {",

                        "vColor = color;",
                        "vUv = uv;",
                        "vAlpha = alpha;",
                        "gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );",

                    "}" ].join("\n");

                var ImFS = [
                    "varying vec3 vColor;",
                    "varying vec2 vUv;",
                    "varying float vAlpha;",
                    
                    "uniform sampler2D tTex;",

                    "void main() {",
                            "gl_FragColor = vec4( vColor, texture2D( tTex, vUv ).a * vAlpha );",
                    "}" ].join("\n");

                var material = new THREE.ShaderMaterial( {
                    uniforms: guniforms,
                    vertexShader: ImVS,
                    fragmentShader: ImFS,
                    vertexColors: THREE.VertexColors,
                    transparent: true,
                    side: THREE.DoubleSide } );

                /*let texture = document.createElement("canvas");
                texture.width = data.tex.w;
                texture.height = data.tex.h;
                let tctx = texture.getContext('2d');
                for (let i = 0; i < data.tex.h; ++i) {
                    for (let j = 0; j < data.tex.w; ++j) {
                        let col = data.tex.p[i*data.tex.w+j]/255;
                        tctx.fillStyle = 'rgba(' + col + ',' + col + ',' + col + ',' + col + ')';
                        tctx.fillRect(j, i, 1, 1);
                    }
                }*/

                
                const scene = new THREE.Scene();
                const camera = new THREE.OrthographicCamera( 0, window.innerWidth, 0, window.innerHeight, -1, 1 );
                camera.position.z = 1;

                var MAX_TRIANGLES = 21844; // *3 ~= 65536

                geometry = new THREE.BufferGeometry();
                geometry.setIndex( new THREE.BufferAttribute( new Uint16Array ( MAX_TRIANGLES * 3 ), 1) );
                geometry.setAttribute( 'position', new THREE.BufferAttribute( new Float32Array( MAX_TRIANGLES * 3 * 3 ), 3 ) );
                geometry.setAttribute( 'uv',       new THREE.BufferAttribute( new Float32Array( MAX_TRIANGLES * 2 * 3 ), 2 ) );
                geometry.setAttribute( 'color',    new THREE.BufferAttribute( new Float32Array( MAX_TRIANGLES * 3 * 3 ), 3 ) );
                geometry.setAttribute( 'alpha',    new THREE.BufferAttribute( new Float32Array( MAX_TRIANGLES * 1     ), 1 ) );
                geometry.dynamic = true;
                geometry.offsets = [ { start: 0, index: 0, count: 0 } ];

                var mesh = new THREE.Mesh( geometry, material );
                mesh.frustumCulled = false;
                scene.add( mesh );

                const posArr = geometry.attributes.position.array;
                const colorArr = geometry.attributes.color.array;
                const alphaArr = geometry.attributes.alpha.array;
                const uvArray = geometry.attributes.uv.array;
                const indexArray = geometry.index.array;
                for (let i = 0; i < data.vtx.length; ++i) {
                    const raw_color = data.vtx[i][2];
                    posArr[i*3] = data.vtx[i][0];
                    posArr[i*3+1] = data.vtx[i][1];
                    posArr[i*3+2] = 0;
                    colorArr[i*3] = (raw_color & 255)/255;
                    colorArr[i*3+1] = (raw_color>>8 & 255)/255;
                    colorArr[i*3+2] = (raw_color>>16 & 255)/255;
                    alphaArr[i] = (raw_color>>24 & 255)/255;
                    uvArray[i*2] = data.vtx[i][3];
                    uvArray[i*2+1] = 1-data.vtx[i][4];
                }

                for (let i = 0; i < data.idx.length; ++i) {
                    indexArray[i] = data.idx[i];
                }

                geometry.attributes.position.needsUpdate = true;
                geometry.attributes.uv.needsUpdate = true;
                geometry.attributes.color.needsUpdate = true;
                geometry.attributes.alpha.needsUpdate = true;
                geometry.index.needsUpdate = true;


                var map = new THREE.TextureLoader().load( "texture.png" );
                map.needsUpdate = true;
                map.minFilter = map.magFilter = THREE.NearestFilter;
                guniforms.tTex.value = map;

                const renderer = new THREE.WebGLRenderer();
                renderer.setSize( window.innerWidth, window.innerHeight );
                document.body.appendChild( renderer.domElement );

                geometry.setDrawRange(0, data.idx.length);
                renderer.render( scene, camera );
                var range = 0;

                const animate = function () {
                    requestAnimationFrame(animate);
                    geometry.setDrawRange(0, range);
                    renderer.render( scene, camera );
                    range = (range+1) % (data.idx.length+1);
                }

                animate();
            });

		</script>
	</body>
</html>